<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador IBGE - Dashboard de Estudos</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="portugues.js"></script>
    <script src="geografia.js"></script>
    <script src="etica.js"></script>
    <script src="matematica.js"></script>

    <style>
        :root { --p: #003366; --s: #ffcc00; --success: #28a745; --danger: #dc3545; --bg: #f4f7f9; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 20px; margin: 0; }
        .card { background: white; width: 100%; max-width: 800px; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; }
        
        /* Telas */
        #start-screen, #quiz-ui, #results { display: none; }
        #start-screen { display: block; } /* Mostra apenas a inicial no começo */

        .header { border-bottom: 3px solid var(--s); margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; padding-bottom: 10px; }
        #timer { font-weight: bold; color: var(--danger); background: #fff1f0; padding: 8px 15px; border-radius: 25px; border: 1px solid #ffccc7; }
        .prog-container { height: 10px; background: #eee; border-radius: 5px; margin-bottom: 20px; overflow: hidden; }
        #prog-fill { height: 100%; background: var(--p); width: 0%; transition: 0.4s; }
        .badge { background: var(--s); color: #000; padding: 5px 12px; border-radius: 5px; font-size: 12px; font-weight: bold; text-transform: uppercase; }
        .options { list-style: none; padding: 0; margin-top: 25px; text-align: left; }
        .options li { background: #f8f9fa; padding: 18px; margin-bottom: 12px; border-radius: 10px; cursor: pointer; border: 2px solid #eef0f2; transition: 0.2s; }
        .options li:hover { background: #f1f3f5; border-color: #d1d9e0; }
        .options li.selected { border-color: var(--p); background: #eef6ff; font-weight: bold; }
        .btn { width: 100%; padding: 18px; background: var(--p); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 16px; margin-top: 20px; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .chart-box { margin-top: 30px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 600px) { .chart-box { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="card">
    <div id="start-screen">
        <h1 style="color: var(--p);">Simulador Preparatório IBGE</h1>
        <p style="color: #666; margin-bottom: 30px;">O teste contém 20 questões aleatórias das 4 matérias do edital.</p>
        <div style="background: #fdf6e3; padding: 20px; border-radius: 10px; margin-bottom: 30px; border-left: 5px solid var(--s); text-align: left;">
            <p><strong>Dicas:</strong></p>
            <ul style="color: #555;">
                <li>O cronômetro começará assim que você clicar no botão abaixo.</li>
                <li>Você pode revisar seu desempenho por matéria ao final.</li>
                <li>Leia as questões com atenção!</li>
            </ul>
        </div>
        <button class="btn" style="background: var(--success);" onclick="startSimulated()">INICIAR TESTE AGORA</button>
    </div>

    <div id="quiz-ui">
        <div class="header">
            <h2 style="color: var(--p); margin: 0;">Simulado IBGE</h2>
            <div id="timer">Tempo: 00:00</div>
        </div>
        <div class="prog-container"><div id="prog-fill"></div></div>
        <div style="text-align: left;"><span id="subject-badge" class="badge">Matéria</span></div>
        <p id="question-text" style="font-size: 1.2rem; line-height: 1.5; color: #333; margin-top: 20px; text-align: left;"></p>
        <ul id="options-list" class="options"></ul>
        <button class="btn" onclick="handleNext()">Confirmar Resposta</button>
    </div>

    <div id="results">
        <h2 style="color: var(--p);">Análise de Resultado</h2>
        <div id="score-summary" style="font-size: 1.2rem; margin-bottom: 20px;"></div>
        <div class="chart-box">
            <div style="height: 300px;"><canvas id="mainChart"></canvas></div>
            <div style="height: 300px;"><canvas id="subjectChart"></canvas></div>
        </div>
        <button class="btn" onclick="location.reload()">Reiniciar Simulado</button>
    </div>
</div>

<script>
    let selectedOption = null; 
    let currentIdx = 0;
    let userAnswers = [];
    let seconds = 0;
    let quizSet = [];
    let timerInterval;

    // Função para preparar o banco e mostrar a tela de quiz
    function startSimulated() {
        try {
            const fullDatabase = [
                ...(typeof questionsPort !== 'undefined' ? questionsPort : []),
                ...(typeof questionsGeo !== 'undefined' ? questionsGeo : []),
                ...(typeof questionsEtica !== 'undefined' ? questionsEtica : []),
                ...(typeof questionsMat !== 'undefined' ? questionsMat : [])
            ];

            if (fullDatabase.length === 0) {
                alert("Erro: Banco de questões não carregado. Verifique os arquivos .js");
                return;
            }

            quizSet = fullDatabase.sort(() => Math.random() - 0.5).slice(0, 20);
            
            // Troca de tela
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('quiz-ui').style.display = 'block';
            
            startTimer();
            displayQuestion();
        } catch (e) {
            console.error(e);
            alert("Erro ao iniciar. Verifique se os arquivos .js estão na mesma pasta.");
        }
    }

    function startTimer() {
        timerInterval = setInterval(() => {
            seconds++;
            let m = Math.floor(seconds / 60).toString().padStart(2, '0');
            let s = (seconds % 60).toString().padStart(2, '0');
            document.getElementById('timer').innerText = `Tempo: ${m}:${s}`;
        }, 1000);
    }

    function displayQuestion() {
        selectedOption = null;
        let q = quizSet[currentIdx];
        
        document.getElementById('prog-fill').style.width = (currentIdx / quizSet.length) * 100 + "%";
        document.getElementById('subject-badge').innerText = q.subject;
        document.getElementById('question-text').innerText = `${currentIdx + 1}. ${q.q}`;
        
        let list = document.getElementById('options-list');
        list.innerHTML = "";
        
        q.options.forEach((opt, i) => {
            let li = document.createElement('li');
            li.innerText = opt;
            li.onclick = () => {
                document.querySelectorAll('#options-list li').forEach(el => el.classList.remove('selected'));
                li.classList.add('selected');
                selectedOption = i;
            };
            list.appendChild(li);
        });
    }

    function handleNext() {
        if (selectedOption === null) {
            alert("Por favor, selecione uma opção!");
            return;
        }
        
        userAnswers.push(selectedOption);
        currentIdx++;

        if (currentIdx < quizSet.length) {
            displayQuestion();
        } else {
            showResults();
        }
    }

    function showResults() {
        clearInterval(timerInterval);
        document.getElementById('quiz-ui').style.display = 'none';
        document.getElementById('results').style.display = 'block';

        let hits = quizSet.filter((q, i) => q.correct === userAnswers[i]).length;
        document.getElementById('score-summary').innerText = `Você acertou ${hits} de ${quizSet.length} questões!`;

        new Chart(document.getElementById('mainChart'), {
            type: 'doughnut',
            data: {
                labels: ['Acertos', 'Erros'],
                datasets: [{ data: [hits, quizSet.length - hits], backgroundColor: ['#28a745', '#dc3545'] }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'Geral' } } }
        });

        let stats = { "Português": 0, "Geografia": 0, "Ética": 0, "Matemática": 0 };
        quizSet.forEach((q, i) => { if (q.correct === userAnswers[i]) stats[q.subject]++; });

        new Chart(document.getElementById('subjectChart'), {
            type: 'bar',
            data: {
                labels: Object.keys(stats),
                datasets: [{ label: 'Acertos', data: Object.values(stats), backgroundColor: '#003366' }]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                plugins: { title: { display: true, text: 'Por Matéria' } },
                scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
            }
        });
    }
</script>
</body>
</html>